<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Third-Person VR Village with Interactive Blackboards</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-environment-component@1.3.0/dist/aframe-environment-component.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; }
        a-scene { height: 100vh; width: 100vw; }
        .file-input { display: none; }
        .file-info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(255,255,255,0.8);
            padding: 5px;
            border-radius: 5px;
            font-family: Arial;
            font-size: 12px;
            max-width: 200px;
            word-wrap: break-word;
        }
        
        /* Modal for description input */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border-radius: 10px;
            width: 50%;
            max-width: 500px;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            font-family: Arial, sans-serif;
        }
        
        textarea {
            width: 100%;
            height: 100px;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-family: Arial, sans-serif;
            resize: vertical;
        }
        
        .button-container {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: Arial, sans-serif;
        }
        
        .submit-btn {
            background-color: #4CAF50;
            color: white;
        }
        
        .cancel-btn {
            background-color: #f44336;
            color: white;
        }
    </style>
</head>
<body>
    <a-scene environment="preset: forest; groundColor: #44582e; dressingAmount: 100">
        <!-- Sky and lighting -->
        <a-sky color="#87CEEB"></a-sky>
        <a-light type="ambient" color="#445588"></a-light>
        <a-light type="directional" color="#ffeeaa" intensity="0.8" position="-1 1 0.5"></a-light>

        <!-- Terrain -->
        <a-entity geometry="primitive: plane; width: 100; height: 100" rotation="-90 0 0" 
                 material="color: #3a5c2b; roughness: 1"></a-entity>

        <!-- Water-filled paddy fields -->
        <a-entity id="paddy-fields" position="0 0 -20">
            <!-- Water surface -->
            <a-plane width="30" height="30" rotation="-90 0 0" position="0 0.1 0"
                     color="#4a80f5" opacity="0.7" roughness="0.2" metalness="0.3"></a-plane>
            
            <!-- Paddy plants -->
            <a-entity id="paddy-plants"></a-entity>
        </a-entity>

        <!-- Village houses -->
        <a-entity position="-10 0 -5">
            <a-box position="0 1.5 0" width="4" height="3" depth="4" color="#8B4513"></a-box>
            <a-box position="0 3.5 0" width="4.5" height="1" depth="4.5" color="#A0522D" rotation="0 10 0"></a-box>
        </a-entity>
        <a-entity id="houses">
            <!-- House 1 -->
            <a-entity position="-15 0 10" rotation="0 30 0">
                <a-box position="0 1.5 0" width="4" height="3" depth="4" color="#8B4513"></a-box>
                <a-box position="0 3.5 0" width="4.5" height="1" depth="4.5" color="#A0522D" rotation="0 10 0"></a-box>
                <a-cone position="0 4.5 0" radius-bottom="2.5" radius-top="0" height="2" color="#8B0000"></a-cone>
            </a-entity>
            
            <!-- House 2 -->
            <a-entity position="20 0 -10" rotation="0 -20 0">
                <a-box position="0 1.5 0" width="5" height="3.5" depth="4" color="#D2B48C"></a-box>
                <a-box position="0 4 0" width="5.5" height="1" depth="4.5" color="#CD853F" rotation="0 5 0"></a-box>
                <a-cylinder position="0 5.5 0" radius="2.8" height="0.5" color="#8B0000"></a-cylinder>
            </a-entity>
            
            <!-- House 3 -->
            <a-entity position="10 0 15" rotation="0 45 0">
                <a-box position="0 1.5 0" width="6" height="2.5" depth="4" color="#BC8F8F"></a-box>
                <a-box position="0 3.5 0" width="6.5" height="0.5" depth="4.5" color="#A0522D"></a-box>
                <a-box position="0 4.25 0" width="6.5" height="0.5" depth="4.5" color="#A0522D" rotation="0 15 0"></a-box>
            </a-entity>
        </a-entity>
        <!-- Interactive blackboards -->
        <a-entity id="blackboards"></a-entity>

        <!-- PLAYER AVATAR -->
        <a-entity id="player-avatar" position="0 0 0">
            <!-- Body -->
            <a-cylinder id="body" radius="0.3" height="1.7" position="0 0.85 0" color="#4682B4"></a-cylinder>
            
            <!-- Head -->
            <a-sphere radius="0.25" position="0 1.6 0" color="#FFD3B6"></a-sphere>
            
            <!-- Eyes -->
            <a-sphere radius="0.05" position="-0.1 1.65 0.2" color="white"></a-sphere>
            <a-sphere radius="0.05" position="0.1 1.65 0.2" color="white"></a-sphere>
            
            <!-- Legs (animated) -->
            <a-box id="left-leg" width="0.2" height="0.8" depth="0.2" position="-0.15 0.4 0" color="#000000"></a-box>
            <a-box id="right-leg" width="0.2" height="0.8" depth="0.2" position="0.15 0.4 0" color="#000000"></a-box>
            
            <!-- Arms (animated) -->
            <a-box id="left-arm" width="0.2" height="0.8" depth="0.2" position="-0.3 1.1 0" rotation="0 0 30" color="#FFD3B6"></a-box>
            <a-box id="right-arm" width="0.2" height="0.8" depth="0.2" position="0.3 1.1 0" rotation="0 0 -30" color="#FFD3B6"></a-box>
        </a-entity>

        <!-- Third-person camera rig -->
        <a-entity id="camera-rig">
            <!-- Camera with offset -->
            <a-entity id="camera" camera position="0 2 -5" look-controls wasd-controls="fly: false">
                <a-cursor></a-cursor>
            </a-entity>
        </a-entity>

        <!-- Hidden file input for uploads -->
        <input type="file" id="file-input" class="file-input" accept=".pdf,.doc,.docx,.mp4,.mov,.avi,.jpg,.jpeg,.png">
    </a-scene>
    
    <!-- Description modal -->
    <div id="description-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title">Enter a description for your file</div>
            <textarea id="description-input" placeholder="Describe your file here..."></textarea>
            <div class="button-container">
                <button class="cancel-btn" onclick="cancelDescription()">Cancel</button>
                <button class="submit-btn" onclick="submitDescription()">Submit</button>
            </div>
        </div>
    </div>

    <script>
        // Create paddy plants
        const paddyField = document.querySelector('#paddy-plants');
        const plantCount = 200;
        
        for (let i = 0; i < plantCount; i++) {
            const plant = document.createElement('a-entity');
            const x = (Math.random() - 0.5) * 28;
            const z = (Math.random() - 0.5) * 28;
            const height = 0.8 + Math.random() * 0.4;
            const tilt = (Math.random() - 0.5) * 15;
            
            plant.setAttribute('position', `${x} 0 ${z}`);
            plant.setAttribute('rotation', `${tilt} 0 0`);
            plant.setAttribute('class', 'paddy-plant');
            
            let plantHTML = '';
            const strandCount = 5 + Math.floor(Math.random() * 5);
            
            for (let s = 0; s < strandCount; s++) {
                const angle = (s / strandCount) * 360;
                const radius = 0.05;
                const sx = Math.sin(angle * Math.PI/180) * radius;
                const sz = Math.cos(angle * Math.PI/180) * radius;
                const curve = (Math.random() - 0.5) * 0.2;
                
                plantHTML += `
                    <a-entity position="${sx} 0 ${sz}">
                        <a-tube path="0 0 0, ${curve} ${height*0.7} ${curve*0.5}, ${curve*1.5} ${height} 0"
                                radius="0.01" segments-radial="4" color="#8FBC8F" roughness="0.8"></a-tube>
                        <a-sphere position="${curve*1.5} ${height} 0" radius="0.05" color="#FFD700" roughness="0.3"></a-sphere>
                    </a-entity>
                `;
            }
            
            plant.innerHTML = plantHTML;
            paddyField.appendChild(plant);
        }

        // Wind animation
        setInterval(() => {
            const wind = Math.sin(Date.now() / 1500) * 10;
            document.querySelectorAll('.paddy-plant').forEach(plant => {
                const sway = wind * (0.1 + Math.random() * 0.3);
                const currentRotation = plant.getAttribute('rotation');
                plant.setAttribute('rotation', `${currentRotation.x} ${sway} ${currentRotation.z}`);
            });
        }, 50);

        // Create elegant blackboards at random positions
        const blackboards = document.querySelector('#blackboards');
        const boardCount = 5;
        
        for (let i = 0; i < boardCount; i++) {
            const board = document.createElement('a-entity');
            const x = (Math.random() - 0.5) * 40;
            const z = (Math.random() - 0.5) * 40;
            const rotationY = Math.random() * 360;
            
            board.setAttribute('position', `${x} 1.5 ${z}`);
            board.setAttribute('rotation', `0 ${rotationY} 0`);
            board.setAttribute('class', 'blackboard');
            board.setAttribute('id', `blackboard-${i}`);
            
            board.innerHTML = `
                <a-entity position="0 0 0">
                    <!-- Blackboard frame -->
                    <a-box width="3.2" height="2.2" depth="0.1" position="0 0 -0.06" color="#654321" roughness="0.7"></a-box>
                    <!-- Blackboard surface with chalkboard texture -->
                    <a-plane width="3" height="2" color="#1a1a1a" class="clickable" 
                            material="shader: flat; side: double; roughness: 0.9; src: https://img.freepik.com/free-photo/blackboard-texture_1194-6851.jpg; repeat: 3 2">
                        <a-text value="Click to upload file" color="#ffffff" align="center" width="2.8" position="0 0.8 0.01" opacity="0.8"></a-text>
                        <a-text class="file-name" value="" color="#ffffff" align="center" width="2.8" position="0 0.6 0.01" opacity="0.8" font="kelsonsans"></a-text>
                        <a-text class="file-type" value="" color="#f1c40f" align="center" width="2.8" position="0 0.4 0.01" font="kelsonsans"></a-text>
                        <a-text class="file-size" value="" color="#95a5a6" align="center" width="2.8" position="0 0.2 0.01" font="kelsonsans"></a-text>
                        <a-text class="file-description" value="" color="#3498db" align="center" width="2.8" position="0 -0.2 0.01" wrap-count="30" font="kelsonsans"></a-text>
                        <a-text value="Description:" color="#ffffff" align="center" width="2.8" position="0 0 0.01" opacity="0.8" font="kelsonsans" visible="false" class="description-label"></a-text>
                        <a-image class="file-preview" width="1.5" height="1" position="0 -0.8 0.01" visible="false"></a-image>
                    </a-plane>
                    <!-- Elegant stand -->
                    <a-entity position="0 -1.1 0">
                        <a-cylinder radius="0.1" height="0.2" position="0 0 0" color="#654321" roughness="0.7"></a-cylinder>
                        <a-cylinder radius="0.08" height="2" position="-1.55 1 0" color="#654321" roughness="0.7" rotation="0 0 15"></a-cylinder>
                        <a-cylinder radius="0.08" height="2" position="1.55 1 0" color="#654321" roughness="0.7" rotation="0 0 -15"></a-cylinder>
                    </a-entity>
                </a-entity>
            `;
            
            blackboards.appendChild(board);
        }

        // File upload and description functionality
        const fileInput = document.querySelector('#file-input');
        const descriptionModal = document.querySelector('#description-modal');
        const descriptionInput = document.querySelector('#description-input');
        let currentBoard = null;
        let currentFile = null;
        
        // Click handler for blackboards
        document.querySelectorAll('.blackboard .clickable').forEach(board => {
            board.addEventListener('click', function() {
                const boardEntity = this.parentElement.parentElement;
                currentBoard = boardEntity;
                
                // Trigger file input click
                fileInput.click();
            });
        });
        
        // Handle file selection
        fileInput.addEventListener('change', function(e) {
            if (!currentBoard) return;
            
            const file = e.target.files[0];
            if (!file) return;
            
            currentFile = file;
            
            // Show description modal
            descriptionModal.style.display = 'block';
        });
        
        // Cancel description input
        function cancelDescription() {
            descriptionModal.style.display = 'none';
            currentFile = null;
            fileInput.value = '';
        }
        
        // Submit description and complete file upload
        function submitDescription() {
            const description = descriptionInput.value || "No description provided.";
            
            if (!currentBoard || !currentFile) {
                descriptionModal.style.display = 'none';
                return;
            }
            
            // Update board with file info
            const fileName = currentBoard.querySelector('.file-name');
            const fileType = currentBoard.querySelector('.file-type');
            const fileSize = currentBoard.querySelector('.file-size');
            const filePreview = currentBoard.querySelector('.file-preview');
            const fileDescription = currentBoard.querySelector('.file-description');
            const descriptionLabel = currentBoard.querySelector('.description-label');
            
            // Clear previous preview if any
            filePreview.setAttribute('visible', 'false');
            
            // Display file name (truncate if too long)
            const displayName = currentFile.name.length > 20 ? currentFile.name.substring(0, 17) + '...' : currentFile.name;
            fileName.setAttribute('value', displayName);
            
            // Set type and size information
            let typeText = '';
            let sizeText = '';
            
            if (currentFile.type.includes('video')) {
                typeText = 'VIDEO FILE';
                sizeText = `${(currentFile.size / (1024 * 1024)).toFixed(1)} MB`;
                // You could add a video icon here if desired
            } 
            else if (currentFile.type.includes('pdf')) {
                typeText = 'PDF DOCUMENT';
                sizeText = `${(currentFile.size / 1024).toFixed(1)} KB`;
            } 
            else if (currentFile.type.includes('word') || currentFile.name.endsWith('.doc') || currentFile.name.endsWith('.docx')) {
                typeText = 'WORD DOCUMENT';
                sizeText = `${(currentFile.size / 1024).toFixed(1)} KB`;
            }
            else if (currentFile.type.includes('image')) {
                typeText = 'IMAGE';
                sizeText = `${(currentFile.size / 1024).toFixed(1)} KB`;
                
                // Create preview for images
                const reader = new FileReader();
                reader.onload = function(e) {
                    filePreview.setAttribute('src', e.target.result);
                    filePreview.setAttribute('visible', 'true');
                };
                reader.readAsDataURL(currentFile);
            }
            else {
                typeText = 'FILE';
                sizeText = `${(currentFile.size / 1024).toFixed(1)} KB`;
            }
            
            fileType.setAttribute('value', typeText);
            fileSize.setAttribute('value', sizeText);
            
            // Set description and make label visible
            fileDescription.setAttribute('value', description);
            descriptionLabel.setAttribute('visible', 'true');
            
            // Reset modal
            descriptionModal.style.display = 'none';
            descriptionInput.value = '';
            currentFile = null;
            fileInput.value = '';
        }

        // Avatar movement system
        const avatar = document.querySelector('#player-avatar');
        const cameraRig = document.querySelector('#camera-rig');
        const camera = document.querySelector('#camera');
        const leftLeg = document.querySelector('#left-leg');
        const rightLeg = document.querySelector('#right-leg');
        const leftArm = document.querySelector('#left-arm');
        const rightArm = document.querySelector('#right-arm');
        
        let isWalking = false;
        let walkCycle = 0;
        const moveSpeed = 0.1;
        const turnSpeed = 2;
        
        // Keyboard controls
        const keys = {
            w: false, a: false, s: false, d: false,
            ArrowLeft: false, ArrowRight: false
        };
        
        document.addEventListener('keydown', (e) => keys[e.key] = true);
        document.addEventListener('keyup', (e) => keys[e.key] = false);
        
        // Initialize camera position
        cameraRig.setAttribute('position', avatar.getAttribute('position'));
        
        // Animation and movement loop
        function update() {
            const avatarRotation = avatar.getAttribute('rotation');
            const avatarPosition = avatar.getAttribute('position');
            const cameraPosition = camera.getAttribute('position');
            
            // Movement - now based on camera direction when moving forward
            if (keys.w || keys.s || keys.a || keys.d) {
                isWalking = true;
                
                // Get camera rotation to determine forward direction
                const cameraRotation = camera.getAttribute('rotation');
                const angle = cameraRotation.y * Math.PI / 180;
                
                // Forward vector based on camera's y rotation (left/right)
                const forward = new THREE.Vector3(
                    Math.sin(angle),
                    0,
                    Math.cos(angle)
                ).normalize();
                
                // Right vector perpendicular to forward
                const right = new THREE.Vector3(
                    Math.sin(angle + Math.PI/2),
                    0,
                    Math.cos(angle + Math.PI/2)
                ).normalize();
                
                // Apply movement
                const moveVector = new THREE.Vector3();
                if (keys.w) moveVector.add(forward);
                if (keys.s) moveVector.sub(forward);
                if (keys.d) moveVector.add(right);
                if (keys.a) moveVector.sub(right);
                
                moveVector.normalize().multiplyScalar(moveSpeed);
                avatar.setAttribute('position', {
                    x: avatarPosition.x + moveVector.x,
                    y: avatarPosition.y,
                    z: avatarPosition.z + moveVector.z
                });
                
                // Rotate avatar to face movement direction when moving forward/backward
                if (keys.w || keys.s) {
                    const targetAngle = Math.atan2(moveVector.x, moveVector.z) * 180 / Math.PI;
                    avatar.setAttribute('rotation', {
                        y: targetAngle,
                        x: 0,
                        z: 0
                    });
                }
            } else {
                isWalking = false;
            }
            
            // Rotation with arrow keys (independent of camera)
            if (keys.ArrowLeft) {
                avatar.setAttribute('rotation', {
                    y: avatarRotation.y - turnSpeed,
                    x: 0,
                    z: 0
                });
            }
            if (keys.ArrowRight) {
                avatar.setAttribute('rotation', {
                    y: avatarRotation.y + turnSpeed,
                    x: 0,
                    z: 0
                });
            }
            
            // Walking animation
            if (isWalking) {
                walkCycle += 0.2;
                const legSwing = Math.sin(walkCycle) * 30;
                const armSwing = Math.sin(walkCycle) * 20;
                
                leftLeg.setAttribute('rotation', `${legSwing} 0 0`);
                rightLeg.setAttribute('rotation', `${-legSwing} 0 0`);
                leftArm.setAttribute('rotation', `${-armSwing} 0 0`);
                rightArm.setAttribute('rotation', `${armSwing} 0 0`);
            } else {
                // Reset to standing position
                leftLeg.setAttribute('rotation', '0 0 0');
                rightLeg.setAttribute('rotation', '0 0 0');
                leftArm.setAttribute('rotation', '0 0 30');
                rightArm.setAttribute('rotation', '0 0 -30');
            }
            
            // Camera rig follows avatar smoothly
            const currentRigPos = cameraRig.getAttribute('position');
            const targetX = avatarPosition.x;
            const targetZ = avatarPosition.z;
            
            // Simple smoothing for camera follow
            const smoothFactor = 0.1;
            const newX = currentRigPos.x + (targetX - currentRigPos.x) * smoothFactor;
            const newZ = currentRigPos.z + (targetZ - currentRigPos.z) * smoothFactor;
            
            cameraRig.setAttribute('position', {
                x: newX,
                y: avatarPosition.y,
                z: newZ
            });
            
            // Camera looks at avatar (adjust this to see more of the body)
            camera.lookAt(avatar.object3D.position);
            
            requestAnimationFrame(update);
        }
        
        update();
    </script>
</body>
</html>