<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Crop Yield Predictor</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #1e1e2f, #2c2c3e);
      color: #f0f0f0;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    .chat-container {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(15px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      max-width: 700px;
      width: 100%;
      height: 80vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    .chat-header {
      padding: 20px;
      background: #29294d;
      text-align: center;
      font-size: 1.5em;
      font-weight: bold;
      border-bottom: 1px solid #444;
      color: #4dd0e1;
    }
    .chat-messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .message {
      padding: 12px 18px;
      border-radius: 20px;
      max-width: 80%;
      animation: fadeInUp 0.4s ease;
      word-break: break-word;
    }
    .bot-message {
      align-self: flex-start;
      background: #3a3a5d;
      border-bottom-left-radius: 5px;
    }
    .user-message {
      align-self: flex-end;
      background: #4dd0e1;
      color: #000;
      border-bottom-right-radius: 5px;
    }
    @keyframes fadeInUp {
      0% { opacity: 0; transform: translateY(10px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    .input-area {
      display: flex;
      padding: 15px;
      background: #2b2b42;
      border-top: 1px solid #444;
      gap: 10px;
    }
    #userInput {
      flex: 1;
      padding: 12px 15px;
      border: none;
      border-radius: 20px;
      background: #444;
      color: white;
      font-size: 1em;
      outline: none;
    }
    #sendButton {
      padding: 12px 20px;
      border: none;
      border-radius: 20px;
      background: #4dd0e1;
      color: #000;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s;
    }
    #sendButton:hover {
      background: #26c6da;
    }
    .typing-indicator {
      font-style: italic;
      font-size: 0.9em;
      color: #bbb;
      padding-left: 20px;
      display: none;
    }
    .result-card {
      background: rgba(77, 208, 225, 0.1);
      border-left: 4px solid #4dd0e1;
      padding: 15px;
      border-radius: 10px;
      margin-top: 15px;
    }
    ul {
      padding-left: 20px;
    }
    li {
      margin-bottom: 4px;
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">ðŸŒ¾ Crop Yield Assistant</div>
    <div class="chat-messages" id="chatMessages">
      <div class="message bot-message">
        Hello! I'll help you predict crop yield. Let's start with the crop type. What are you growing?
      </div>
    </div>
    <div class="typing-indicator" id="typingIndicator">Assistant is typing...</div>
    <div class="input-area">
      <input type="text" id="userInput" placeholder="Type your answer here..." />
      <button id="sendButton">Send</button>
    </div>
  </div>

  <script>
    const conversationFlow = [
      { question: "What crop are you growing?", field: "Crop" },
      { question: "Which season is this for? (Kharif/Rabi/Summer/Whole Year)", field: "Season" },
      { question: "Which state is this in?", field: "State" },
      { question: "What is the cultivation area in hectares?", field: "Area", type: "number" },
      { question: "What is the expected production in tonnes?", field: "Production", type: "number" },
      { question: "What is the annual rainfall in mm?", field: "Annual_Rainfall", type: "number" },
      { question: "How much fertilizer will you use (kg/hectare)?", field: "Fertilizer", type: "number" },
      { question: "How much pesticide will you use (kg/hectare)?", field: "Pesticide", type: "number" }
    ];

    let currentStep = 0;
    const formData = {};
    const chatMessages = document.getElementById('chatMessages');
    const userInput = document.getElementById('userInput');
    const sendButton = document.getElementById('sendButton');
    const typingIndicator = document.getElementById('typingIndicator');

    userInput.focus();

    sendButton.addEventListener('click', processInput);
    userInput.addEventListener('keypress', function (e) {
      if (e.key === 'Enter') processInput();
    });

    function processInput() {
      const userMessage = userInput.value.trim();
      if (!userMessage) return;

      addMessage(userMessage, 'user-message');
      userInput.value = '';
      typingIndicator.style.display = 'block';

      setTimeout(() => {
        typingIndicator.style.display = 'none';

        const currentField = conversationFlow[currentStep].field;
        formData[currentField] = userMessage;

        currentStep++;
        if (currentStep < conversationFlow.length) {
          askNextQuestion();
        } else {
          submitForm();
        }
      }, 700);
    }

    function askNextQuestion() {
      const nextQ = conversationFlow[currentStep];
      addMessage(nextQ.question, 'bot-message');
      userInput.type = nextQ.type || 'text';
      userInput.placeholder = `Enter ${nextQ.field}...`;
      userInput.focus();
    }

    function addMessage(text, className) {
      const msg = document.createElement('div');
      msg.className = `message ${className}`;
      msg.textContent = text;
      chatMessages.appendChild(msg);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function submitForm() {
      addMessage("Calculating your yield prediction...", 'bot-message');
      formData['Crop_Year'] = new Date().getFullYear();

      fetch("{% url 'yield_predictor' %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(formData)
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          const result = `
            <div class="result-card">
              <h3>Prediction Result</h3>
              <p><strong>Predicted Yield:</strong> ${data.predicted_yield} tonnes/hectare</p>
              <p><strong>Input Details:</strong></p>
              <ul>
                <li>Crop: ${data.input_data.Crop}</li>
                <li>Season: ${data.input_data.Season}</li>
                <li>State: ${data.input_data.State}</li>
                <li>Area: ${data.input_data.Area} hectares</li>
              </ul>
            </div>
            <div class="message bot-message">Would you like to make another prediction?</div>
          `;
          const resultContainer = document.createElement('div');
          resultContainer.innerHTML = result;
          chatMessages.appendChild(resultContainer);
          chatMessages.scrollTop = chatMessages.scrollHeight;

          currentStep = 0;
          Object.keys(formData).forEach(key => delete formData[key]);
          askNextQuestion();
        } else {
          addMessage(`Error: ${data.error}`, 'bot-message');
        }
      })
      .catch(err => {
        addMessage(`Error: ${err.message}`, 'bot-message');
      });
    }
  </script>
</body>
</html>
